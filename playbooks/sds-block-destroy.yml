---
- name: Destroy Hitachi SDS Block Infrastructure
  hosts: localhost
  become: false
  gather_facts: false
  vars_files:
    - ../overrides.yml
    - ../hitachi.overrides.yml
  tasks:
    - name: Print SDS Block destruction info
      ansible.builtin.debug:
        msg: |
          ============================================================
          Destroying Hitachi SDS Block Infrastructure
          ============================================================
          Cluster: {{ ocp_cluster_name }}
          Region: {{ ocp_region }}
          AWS Profile: {{ aws_profile }}
          ============================================================

    # ======================================================================
    # Phase 1: SDS Block Cleanup Script
    # ======================================================================
    - name: Check for Hitachi SDS cleanup script
      ansible.builtin.stat:
        path: "{{ basefolder }}/scripts/cleanup-hitachi-sds-force.sh"
      register: cleanup_script

    - name: Run Hitachi SDS force cleanup script
      ansible.builtin.shell: |
        set -e
        SCRIPT_PATH="{{ basefolder }}/scripts/cleanup-hitachi-sds-force.sh"
        echo "Running Hitachi SDS cleanup for cluster: {{ ocp_cluster_name }} in region: {{ ocp_region }}"
        "$SCRIPT_PATH" --cluster-name "{{ ocp_cluster_name }}" --region "{{ ocp_region }}" --profile "{{ aws_profile }}"
        if [ $? -eq 0 ]; then
          echo "✅ Hitachi SDS cleanup completed successfully"
          sleep 30
        else
          echo "⚠️  Hitachi SDS cleanup completed with warnings"
          sleep 30
        fi
      when: cleanup_script.stat.exists
      failed_when: false
      register: sds_cleanup_result

    - name: Display SDS cleanup output
      ansible.builtin.debug:
        msg: "{{ sds_cleanup_result.stdout_lines }}"
      when: sds_cleanup_result.stdout is defined

    # ======================================================================
    # Phase 2: CloudFormation Stack Deletion
    # ======================================================================
    - name: Delete Hitachi SDS CloudFormation stack
      tags:
        - cf_cleanup
      amazon.aws.cloudformation:
        stack_name: "hitachi-sds-block-{{ ocp_cluster_name }}"
        state: absent
        region: "{{ ocp_region }}"
        profile: "{{ aws_profile }}"
      register: sds_stack_delete
      failed_when: false

    - name: Wait for SDS CloudFormation stack deletion
      tags:
        - cf_cleanup
      amazon.aws.cloudformation_info:
        profile: "{{ aws_profile }}"
        region: "{{ ocp_region }}"
        stack_name: "hitachi-sds-block-{{ ocp_cluster_name }}"
      register: sds_cf_check
      until: sds_cf_check.cloudformation | length == 0
      retries: 60
      delay: 10
      failed_when: false

    # ======================================================================
    # Phase 3: Orphaned Instance Cleanup
    # ======================================================================
    - name: Check for orphaned SDS Block EC2 instances
      tags:
        - ec2_cleanup
      amazon.aws.ec2_instance_info:
        profile: "{{ aws_profile }}"
        region: "{{ ocp_region }}"
        filters:
          "tag:Name": "hitachi-sds-block-*"
          "instance-state-name": "running"
      register: orphaned_sds_instances

    - name: Terminate orphaned SDS Block instances
      tags:
        - ec2_cleanup
      amazon.aws.ec2_instance:
        instance_ids: "{{ item.instance_id }}"
        state: terminated
        region: "{{ ocp_region }}"
        profile: "{{ aws_profile }}"
      loop: "{{ orphaned_sds_instances.instances }}"
      when: orphaned_sds_instances.instances | length > 0

    - name: Wait for orphaned instances to terminate
      tags:
        - ec2_cleanup
      ansible.builtin.pause:
        seconds: 10
      when: orphaned_sds_instances.instances | length > 0

    # ======================================================================
    # Phase 4: Instance Tagging and Final Cleanup
    # ======================================================================
    - name: Check for all SDS Block instances
      tags:
        - final_cleanup
      amazon.aws.ec2_instance_info:
        profile: "{{ aws_profile }}"
        region: "{{ ocp_region }}"
        filters:
          "tag:Name": "hitachi-sds-block-*"
      register: all_sds_instances

    - name: Tag SDS instances for cleanup tracking
      tags:
        - final_cleanup
      block:
        - name: Update tags on SDS instances
          amazon.aws.ec2_tag:
            region: "{{ ocp_region }}"
            profile: "{{ aws_profile }}"
            resource: "{{ item.instance_id }}"
            tags:
              Name: "hitachi-sds-block-{{ ocp_cluster_name }}-destroyed"
              DestroyedAt: "{{ ansible_date_time.iso8601 }}"
            state: present
          loop: "{{ all_sds_instances.instances }}"
          when: all_sds_instances.instances | length > 0

        - name: Print destruction summary
          ansible.builtin.debug:
            msg: |
              ============================================================
              ✅ SDS Block Destruction Complete
              ============================================================
              Cluster: {{ ocp_cluster_name }}
              Region: {{ ocp_region }}
              
              Resources Cleaned:
              - CloudFormation stack: hitachi-sds-block-{{ ocp_cluster_name }}
              - EC2 instances: {{ all_sds_instances.instances | length }} found
              - Status: Terminated/Stopping
              
              Note: Terminated instances will be fully removed from AWS 
              console in approximately 1 hour.
              ============================================================
          when: all_sds_instances.instances | length > 0
      when: all_sds_instances.instances | length > 0
